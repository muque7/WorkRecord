### 实验工具优化需求与方案设计 2020-06-04

##### 相关需求

###### 1.根据特定IP指定实验测试账号

创建实验时新增：根据特定IP指定实验测试账号

与通过id指定实验测试账号互斥

控制粒度：

​	test_ip

​	"create_time_range": [1555718400,1558195200]   角色创建时间的范围，值为unix时间戳

###### 2.增加实验类型参数

增加实验类型参数——传给游戏后端，作为判断是否在redis存储已参与过实验的玩家

实验类型：长期实验，短期实验

实验开始后，不支持中途更改实验方案，要修改只能撤销重新生成

###### 3.结束实验时的应用方案

实验结束，回传增加实验类型参数

##### 接口改动

###### 1.创建实验接口

```json
{
    "mid": 0x10019, //65561
    "payload": {
        //新增的字段
        "experiment_type": "long_term_experiment",  //短期short_term_experiment

        //修改的字段
        "test_players": [
            {"player_id":1000546879, "group_key":"A"},
            {"player_id":1000546879, "group_key":"A"},
           //create_time_range值为unix时间戳，通过前端逻辑保证不会有player_id和test_ip共存，后端做校验
            {"test_ip":65466, "create_time_range":[6486,6846], "group_key":"A"},
            {"test_ip":64564, "create_time_range":[6846,6846], "group_key":"B"}
        ],

        //没有改动的字段
    	"unique_key": "3kg5a",    //分流标识符，详见分流算法的说明
        "deviding_rule": {
            "bucket_sum": 100,    //流量固定分为100份，以便进行灰度调整
            "groups": [
                {
                    "group_key": "A",    //实验变体的标识符
                    "ratio": 40     //该变体所占流量百分比
                },
                {
                    "group_key": "B",
                    "ratio": 30
                },
                {
                    "group_key": "C",
                    "ratio": 30
                }
            ]
        },
        "tracking_event": {    //实验追踪的标志事件，需记录至log_event表
            "event_type": "experiment",    //固定，因为log_event表中还有newer_guide等事件
            "event_name": "3kg5a_000"    //由salt拼接而来，以确保唯一性
        },
        "player_filter":{    //参与实验的角色筛选条件
            "create_time": [1555718400,1558195200], //角色创建时间的范围，值为unix时间戳
            "server_id": [100,101,102],   //服务器id，数组
            "attribute_lang": ["en","fr"] //玩家语言
            //暂无其他筛选条件，之后视需求添加
        },
        "final_group_key": ""    //实验结束时确定的最终使用的组别,创建时没有会传空字符串
    }
}
```

接口返回无改动

###### 2.更改实验接口

```json
{
    "mid": 0x1001a, //65562
    "payload": {
        //新增的字段
        "experiment_type": "long_term_experiment",  //短期short_term_experiment

        //修改的字段
        "test_players": [
            {"player_id":1000546879, "group_key":"A"},
            {"player_id":1000546879, "group_key":"A"},
           //create_time_range值为unix时间戳，通过前端逻辑保证不会有player_id和test_ip共存，后端做校验
            {"test_ip":65466, "create_time_range":[6486,6846], "group_key":"A"},
            {"test_ip":64564, "create_time_range":[6846,6846], "group_key":"B"}
        ],

        //没有改动的字段
        "unique_key": "3kg5a",    //分流标识符，同时也是实验的唯一标识
        "deviding_rule": {        //分流规则
            "bucket_sum": 100,    //流量固定分为100份，以便进行灰度调整
            "groups": [
                {
                    "group_key": "A",    //实验变体名称
                    "ratio": 40     //该变体所占流量百分比
                },
                {
                    "group_key": "B",
                    "ratio": 60
                }
            ]
        },
    }
}
```

接口返回无改动

###### 3.删除和开启实验接口不改动

###### 4.结束实验接口

```json
{
    "mid": 0x1001d, //65565
    "payload": {
    	//新增的字段
        "experiment_type": "long_term_experiment",  //短期short_term_experiment
        "player_filter":{    //参与角色的用户筛选条件
            "create_time": [1555718400,1558195200], //角色创建时间的范围，值为unix时间戳
            "server_id": [100,101,102],   //服务器id，数组
            "attribute_lang": ["en","fr"] //玩家语言
            //暂无其他筛选条件，之后视需求添加
        },
        
        //没有改动的字段
        "unique_key": "3kg5a",    //分流标识符，同时也是实验的唯一标识
        "final_group_key": "A"  //最终确定使用的实验变体
    }
}
```

接口返回无改动

##### 项目代码修改

修改思路，所有使用到experiment_config的控制器方法，都检查一边

##### 新需求

通过id搜索实验玩家参加的实验信息

**解决方式**：编写接口，游戏回传player_id，ip，unique_key，记录到experiments_test_players表中

