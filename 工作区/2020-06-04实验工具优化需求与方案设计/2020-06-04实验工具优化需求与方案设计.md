### 实验工具优化需求与方案设计 2020-06-04

##### 相关需求

###### 1.根据特定IP指定实验测试账号

创建实验时新增：根据特定IP指定实验测试账号

与通过id指定实验测试账号互斥

控制粒度：

​	test_ip

​	过期时间

###### 2.增加实验类型参数

增加实验类型参数——传给游戏后端，作为判断是否在redis存储已参与过实验的玩家

实验类型：长期实验，短期实验

实验开始后，不支持中途更改实验方案，要修改只能撤销重新生成

###### 3.结束实验时的应用方案

实验结束，回传增加实验类型参数，回传分组信息等

###### 4.实现查询所有实验账号功能

能根据id找到所有测试账号，以及他们参与的实验信息

由于通过ip生成的实验玩家平台没有途径获取和保存数据，所以需要游戏保存相关数据（uid，player_id,uniquekey,create_ip,归属实验，归属变体，添加时间等），并提供接口给平台调用

##### 接口改动

1. 创建实验接口和修改实验接口，新增test_ips和fix_group_at_first_participation参数
2. 结束实验接口，新增fix_group_at_first_participation和apply_player_filter参数
3. 注意test_players和test_ips不能同时传值
4. 游戏保存实验玩家的相关信息，提供接口给平台调用

详见文档

##### 相关代码实现

1. 前端传入数据时，验证config内test_players和test_ips不能同时传值---注意考虑兼容

   这里的想法是：前端传入数据必须包含test_players和test_ips两个参数，如果没有则为空数组，两个参数不能同时不为空数组

2. 传数据给游戏时，也同时包含这两个参数，由游戏后端更改逻辑，便于兼容旧版本

##### 代码思路

1. 针对改动1

   在使用config参数前，校验test_ips和fix_group参数

2. 针对改动2

   新增参数，由策划在前台确认，传入到后台，再传到游戏

3. 

